heat_template_version: 2013-05-23

description: >
  HOT template to create a new neutron network plus a router to the public
  network, and for deploying two servers into the new network. The template also
  assigns floating IP addresses to each server so they are routable from the
  public network.

parameters:
  web_server_name:
    type: string
    description: Name to be assigned to the web server
  web_server_flavor:
    type: string
    description: Flavor to use for web server
  key_name:
    type: string
    description: Name of keypair to assign to servers

resources:
  web_server1:
    type: OS::Nova::Server
    properties:
      name: { get_param: web_server_name }
      image: ubuntu-http-base
      flavor: { get_param: web_server_flavor }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: web_server1_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #!/bin/bash
            echo "
            #!/bin/bash
            echo $(ifconfig eth0 | grep 'inet addr' | awk '{print $2}' | awk -F: '{print $2}') $websrv_name.home.local $websrv_name >> /etc/hosts
            mv /etc/resolv.conf /etc/org-resolv.conf
            echo nameserver 192.168.1.1 > /etc/resolv.conf
            route add -net 10.0.2.0/24 gw 10.0.1.2
            mkdir /var/nfsmnt
            mount -t nfs -o ro 192.168.1.2:/home/ninad/openstack/sw_repo /var/nfsmnt
            mkdir /var/www/org-contents
            mv /var/www/* /var/www/org-contents/
            cp -p -r /var/nfsmnt/repository/person_register/* /var/www/
            " > /tmp/1.sh
            sh /tmp/1.sh
          params:
            $websrv_name: { get_param: web_server_name }

  web_server1_port:
    type: OS::Neutron::Port
    properties:
      network_id: d5202a43-ce84-4050-aecf-f889261108a9
      fixed_ips:
        - subnet_id: 9a9e89be-e98c-44ec-9afb-cf2476ade03b

  web_server1_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network_id: d7d3d3a3-a601-4661-8d28-16f02f76ca21
      port_id: { get_resource: web_server1_port }


outputs:
  web_server1_private_ip:
    description: IP address of web server1 in private network
    value: { get_attr: [ web_server1_port, fixed_ips ] }

